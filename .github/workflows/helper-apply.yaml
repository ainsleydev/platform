name: Helper Apply

on:
  workflow_call:
    inputs:
      terraform-directory:
        required: true
        type: string
        description: 'Path to terraform directory (e.g., terraform/base)'
      environment:
        required: true
        type: string
        description: 'GitHub environment for approval gate (e.g., production)'
      download-plan:
        required: false
        type: boolean
        default: true
        description: 'Download and apply saved plan artifact from PR'
      terraform-version:
        required: false
        type: string
        default: '~1.13'
        description: 'Terraform version to use'
      pr-number:
        required: false
        type: string
        default: ''
        description: 'PR number to download plan from (auto-detected if not provided)'
    outputs:
      apply-exitcode:
        description: 'Terraform apply exit code'
        value: ${{ jobs.apply.outputs.exitcode }}

jobs:
  apply:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      exitcode: ${{ steps.apply.outputs.exitcode }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform-version }}
          terraform_wrapper: true

      - name: Find PR Number
        id: find-pr
        if: inputs.download-plan && inputs.pr-number == ''
        uses: actions/github-script@v7
        with:
          script: |
            // Find the PR that was just merged
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });

            const mergedPR = prs.find(pr => pr.merged_at !== null);

            if (mergedPR) {
              console.log(`Found merged PR #${mergedPR.number}`);
              core.setOutput('pr-number', mergedPR.number.toString());
              return mergedPR.number;
            } else {
              console.log('No merged PR found for this commit');
              core.setOutput('pr-number', '');
              return '';
            }

      - name: Download Plan Artifact
        if: inputs.download-plan
        id: download-plan
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tfplan-${{ inputs.pr-number || steps.find-pr.outputs.pr-number || github.sha }}
          path: ${{ inputs.terraform-directory }}

      - name: Terraform Init
        working-directory: ${{ inputs.terraform-directory }}
        env:
          BACK_BLAZE_KEY_ID: ${{ secrets.ORG_BACK_BLAZE_KEY_ID }}
          BACK_BLAZE_APPLICATION_KEY: ${{ secrets.ORG_BACK_BLAZE_APPLICATION_KEY }}
        run: |
          terraform init \
            -backend-config="access_key=${BACK_BLAZE_KEY_ID}" \
            -backend-config="secret_key=${BACK_BLAZE_APPLICATION_KEY}"

      - name: Backup State
        id: backup-state
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          timestamp=$(date +%s)
          terraform state pull > state-backup-${timestamp}.json

          if [ -s state-backup-${timestamp}.json ]; then
            echo "‚úÖ State backed up successfully"
            echo "backup_file=state-backup-${timestamp}.json" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è State backup is empty (this may be first apply)"
          fi

      - name: Upload State Backup
        if: steps.backup-state.outputs.backup_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-backup-${{ github.sha }}
          path: ${{ inputs.terraform-directory }}/${{ steps.backup-state.outputs.backup_file }}
          retention-days: 90

      - name: Terraform Apply (with saved plan)
        id: apply-with-plan
        if: steps.download-plan.outcome == 'success' && hashFiles(format('{0}/tfplan', inputs.terraform-directory)) != ''
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "üì¶ Applying saved plan from PR..."
          terraform apply -no-color tfplan | tee apply-output.txt
          exitcode=${PIPESTATUS[0]}
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          if [ $exitcode -ne 0 ]; then
            echo "::error::Terraform apply failed with exit code $exitcode"
            exit 1
          fi

          echo "‚úÖ Apply completed successfully"

      - name: Terraform Apply (fresh plan)
        id: apply-fresh
        if: steps.apply-with-plan.outcome == 'skipped'
        working-directory: ${{ inputs.terraform-directory }}
        env:
          TF_VAR_hetzner_token: ${{ secrets.ORG_HETZNER_TOKEN }}
          TF_VAR_admin_email: ${{ vars.ADMIN_EMAIL || 'admin@ainsley.dev' }}
          TF_VAR_environment: production
          TF_VAR_project_name: ainsley-dev-platform
        run: |
          echo "‚ö†Ô∏è No saved plan found, generating fresh plan and applying..."
          terraform plan -out=tfplan
          terraform apply -no-color tfplan | tee apply-output.txt
          exitcode=${PIPESTATUS[0]}
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          if [ $exitcode -ne 0 ]; then
            echo "::error::Terraform apply failed with exit code $exitcode"
            exit 1
          fi

          echo "‚úÖ Apply completed successfully"

      - name: Set Combined Output
        id: apply
        run: |
          if [ "${{ steps.apply-with-plan.outcome }}" == "success" ]; then
            echo "exitcode=${{ steps.apply-with-plan.outputs.exitcode }}" >> $GITHUB_OUTPUT
          elif [ "${{ steps.apply-fresh.outcome }}" == "success" ]; then
            echo "exitcode=${{ steps.apply-fresh.outputs.exitcode }}" >> $GITHUB_OUTPUT
          else
            echo "exitcode=1" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Apply Comment Body
        id: prepare-apply-comment
        if: always() && (steps.apply-with-plan.outcome != 'skipped' || steps.apply-fresh.outcome != 'skipped')
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          # Build comment body
          HEADER="## üöÄ Terraform Apply Results"

          SUCCESS="${{ steps.apply.outputs.exitcode == '0' }}"

          if [ "$SUCCESS" == "true" ]; then
            STATUS="‚úÖ **Infrastructure changes applied successfully**"
          else
            STATUS="‚ùå **Apply failed - please check logs**"
          fi

          # Add apply output if available
          APPLY_OUTPUT=""
          if [ -f apply-output.txt ]; then
            APPLY_OUTPUT="<details>
<summary>üìÑ View Apply Output</summary>

\`\`\`
$(cat apply-output.txt)
\`\`\`
</details>"
          fi

          FOOTER="üîó [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Combine all parts using heredoc
          {
            echo "COMMENT_BODY<<EOF"
            echo "$HEADER"
            echo ""
            echo "$STATUS"
            echo ""
            [ -n "$APPLY_OUTPUT" ] && echo "$APPLY_OUTPUT" && echo ""
            echo "$FOOTER"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post Apply Results to PR
        if: always() && (steps.apply-with-plan.outcome != 'skipped' || steps.apply-fresh.outcome != 'skipped') && (inputs.pr-number != '' || steps.find-pr.outputs.pr-number != '')
        uses: ./.github/actions/pr-comment
        continue-on-error: true
        with:
          body-includes: 'Terraform Apply Results'
          comment-body: ${{ steps.prepare-apply-comment.outputs.COMMENT_BODY }}
          issue-number: ${{ inputs.pr-number || steps.find-pr.outputs.pr-number }}
          private-key: ${{ secrets.ORG_GITHUB_APP_PRIVATE_KEY }}

      - name: Post Apply Results as Commit Comment
        if: always() && (steps.apply-with-plan.outcome != 'skipped' || steps.apply-fresh.outcome != 'skipped')
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const body = `${{ steps.prepare-apply-comment.outputs.COMMENT_BODY }}`;

            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: body
              });
              console.log('Posted results as commit comment');
            } catch (error) {
              console.log(`Could not create commit comment: ${error.message}`);
            }

      - name: Cleanup Plan Files
        if: always()
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          rm -f tfplan tfplan.json apply-output.txt state-backup-*.json
