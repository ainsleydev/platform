name: Terraform Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *' # Runs daily at 4 AM UTC

jobs:

  sync-to-gdrive:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 1 Hours
    env:
      BUCKET_NAME: 'ainsley-dev-terraform'
      TF_SLACK_CHANNEL_ID: 'alerts'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for Backblaze B2
        run: |
          rclone config create b2_backup b2 \
            account ${{ secrets.ORG_BACK_BLAZE_KEY_ID }} \
            key ${{ secrets.ORG_BACK_BLAZE_APPLICATION_KEY }}

      - name: Configure rclone for Google Drive
        env:
          GDRIVE_SA_JSON: ${{ secrets.ORG_GOOGLE_DRIVE_SA_JSON }}
          GDRIVE_SHARED_DRIVE_ID: ${{ secrets.ORG_GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          # Create service account credentials file
          echo "$GDRIVE_SA_JSON" > /tmp/gdrive-sa.json

          # Configure Google Drive remote using service account with Shared Drive
          rclone config create gdrive drive \
            scope drive \
            service_account_file /tmp/gdrive-sa.json \
            team_drive "$GDRIVE_SHARED_DRIVE_ID"

      - name: Sync B2 to Google Drive
        run: |
          # Fail on errors, undefined vars, and fail if any part of a pipe fails
          set -euo pipefail

          # Sync entire B2 bucket to Google Drive Shared Drive
          # Structure: {shared-drive}/{bucket-name}/...
          # The bucket name folder (e.g., ainsley-dev-terraform) will be created automatically
          rclone sync b2_backup:${BUCKET_NAME} gdrive:${BUCKET_NAME} \
            --progress \
            --transfers=8 \
            --checkers=8 \
            --drive-chunk-size=64M \
            --exclude ".DS_Store" \
            --exclude "Thumbs.db" \
            --stats=30s \
            --stats-one-line \
            --stats-one-line-date \
            --stats-log-level NOTICE

      - name: Verify Sync
        run: |
          echo "Verifying sync to Google Drive Shared Drive..."

          # List files in Google Drive Shared Drive to verify
          rclone lsd gdrive:${BUCKET_NAME} --max-depth 2

          echo "Google Drive sync completed successfully!"

      - name: Cleanup Credentials
        if: always()
        run: |
          # Remove service account credentials file
          rm -f /tmp/gdrive-sa.json

      - name: Notify Slack of Sync Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          title: 'Terraform Backup Sync Failed'
          message: 'The terraform backup synchronisation to Google Drive has failed.'
          status: 'failure'
          commit_sha: ${{ github.sha }}
          slack_bot_token: ${{ secrets.ORG_SLACK_BOT_TOKEN }}
          channel_id: ${{ env.TF_SLACK_CHANNEL_ID }}
