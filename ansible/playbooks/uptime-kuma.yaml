---
- name: Deploy Uptime Kuma with Docker and Nginx
  hosts: all
  become: true
  vars:
    # Variables to be passed via Terraform/cloud-init
    # domain: status.ainsley.dev
    # admin_email: hello@ainsley.dev
    docker_port: 3001
    service_name: uptime-kuma
    data_mount_point: /mnt/uptime-kuma
    docker_compose_dir: /opt/uptime-kuma
    enable_https: true

  pre_tasks:
    - name: Update apt package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
      register: upgrade_result

    - name: Ensure python3-pip is installed
      apt:
        name: python3-pip
        state: present

    - name: Reboot if kernel updated
      reboot:
        msg: 'Reboot initiated by Ansible due to package upgrade'
        reboot_timeout: 600
      when:
        - upgrade_result.changed
        - skip_reboot is not defined or not skip_reboot

  roles:
    - fail2ban
    - docker
    - nginx
    - ufw

  tasks:
    - name: Check if Hetzner volume is attached
      stat:
        path: "{{ data_mount_point }}"
      register: volume_mount

    - name: Create data mount point directory
      file:
        path: "{{ data_mount_point }}"
        state: directory
        mode: '0755'
      when: not volume_mount.stat.exists

    - name: Find Hetzner volume device
      shell: |
        lsblk -o NAME,SERIAL,MOUNTPOINT | grep -E "HC_Volume" | head -1 | awk '{print "/dev/" $1}'
      register: volume_device
      changed_when: false
      failed_when: false

    - name: Format Hetzner volume if not already formatted
      filesystem:
        fstype: ext4
        dev: "{{ volume_device.stdout }}"
      when:
        - volume_device.stdout != ""
        - not volume_mount.stat.exists
      ignore_errors: yes

    - name: Mount Hetzner volume
      mount:
        path: "{{ data_mount_point }}"
        src: "{{ volume_device.stdout }}"
        fstype: ext4
        state: mounted
        opts: defaults,nofail
      when: volume_device.stdout != ""
      ignore_errors: yes

    - name: Ensure mount point has correct permissions
      file:
        path: "{{ data_mount_point }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create docker-compose directory
      file:
        path: "{{ docker_compose_dir }}"
        state: directory
        mode: '0755'

    - name: Deploy docker-compose.yml for Uptime Kuma
      copy:
        dest: "{{ docker_compose_dir }}/docker-compose.yml"
        mode: '0644'
        content: |
          version: '3.8'

          services:
            uptime-kuma:
              image: louislam/uptime-kuma:1
              container_name: uptime-kuma
              volumes:
                - {{ data_mount_point }}:/app/data
              ports:
                - "{{ docker_port }}:3001"
              restart: unless-stopped
              environment:
                - TZ=Europe/London
              networks:
                - uptime-kuma

          networks:
            uptime-kuma:
              driver: bridge

    - name: Start Uptime Kuma with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ docker_compose_dir }}"
        state: present

    - name: Wait for Uptime Kuma to start
      uri:
        url: "http://localhost:{{ docker_port }}"
        method: GET
        status_code: 200
      register: uptime_kuma_health
      retries: 30
      delay: 5
      until: uptime_kuma_health.status == 200

    - name: Run Certbot to get HTTPS certificate
      include_role:
        name: certbot
      when: enable_https | default(true) | bool

    - name: Deploy SSL Nginx configuration after certificates are obtained
      include_role:
        name: nginx
      vars:
        skip_install: true
      when: enable_https | default(true) | bool

    - name: Display success message
      debug:
        msg: |
          Uptime Kuma has been successfully deployed!

          Service Details:
          ----------------
          Domain: {{ domain }}
          Internal Port: {{ docker_port }}
          Data Location: {{ data_mount_point }}

          Access your Uptime Kuma instance at:
          https://{{ domain }}

          Note: Ensure DNS A record for {{ domain }} points to this server's IP.
