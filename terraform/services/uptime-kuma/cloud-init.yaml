#cloud-config
hostname: uptime-kuma

# Debug with:
# cat /var/log/cloud-init.log
# cat /var/log/cloud-init-output.log

# Update packages
package_update: true
package_upgrade: true

# Install required packages
packages:
  - software-properties-common
  - curl
  - git
  - python3
  - python3-pip

write_files:
  # Create ansible inventory file
  - path: /tmp/ansible-inventory.ini
    content: |
      [uptime_kuma]
      localhost ansible_connection=local
    permissions: '0644'

  # Create ansible playbook
  - path: /tmp/uptime-kuma-playbook.yaml
    content: |
      ---
      - name: Deploy Uptime Kuma with Docker and Nginx
        hosts: all
        become: true
        vars:
          domain: ${domain}
          admin_email: ${admin_email}
          docker_port: 3001
          service_name: uptime-kuma
          data_mount_point: /mnt/uptime-kuma
          docker_compose_dir: /opt/uptime-kuma
          enable_https: true

        pre_tasks:
          - name: Update apt package cache
            apt:
              update_cache: yes
              cache_valid_time: 3600

          - name: Ensure python3-pip is installed
            apt:
              name: python3-pip
              state: present

        roles:
          - fail2ban
          - docker
          - nginx
          - ufw

        tasks:
          - name: Create data mount point directory
            file:
              path: "{{ data_mount_point }}"
              state: directory
              mode: '0755'

          - name: Find Hetzner volume device
            shell: |
              sleep 10
              lsblk -o NAME,SERIAL,MOUNTPOINT | grep -E "HC_Volume" | head -1 | awk '{print "/dev/" $1}'
            register: volume_device
            changed_when: false
            failed_when: false
            retries: 5
            delay: 5
            until: volume_device.stdout != ""

          - name: Check if volume is already formatted
            command: blkid {{ volume_device.stdout }}
            register: blkid_result
            failed_when: false
            changed_when: false
            when: volume_device.stdout != ""

          - name: Format Hetzner volume if not already formatted
            filesystem:
              fstype: ext4
              dev: "{{ volume_device.stdout }}"
            when:
              - volume_device.stdout != ""
              - blkid_result.rc != 0

          - name: Mount Hetzner volume
            mount:
              path: "{{ data_mount_point }}"
              src: "{{ volume_device.stdout }}"
              fstype: ext4
              state: mounted
              opts: defaults,nofail
            when: volume_device.stdout != ""

          - name: Ensure mount point has correct permissions
            file:
              path: "{{ data_mount_point }}"
              state: directory
              mode: '0755'
              owner: root
              group: root

          - name: Create docker-compose directory
            file:
              path: "{{ docker_compose_dir }}"
              state: directory
              mode: '0755'

          - name: Deploy docker-compose.yml for Uptime Kuma
            copy:
              dest: "{{ docker_compose_dir }}/docker-compose.yml"
              mode: '0644'
              content: |
                version: '3.8'

                services:
                  uptime-kuma:
                    image: louislam/uptime-kuma:1
                    container_name: uptime-kuma
                    volumes:
                      - {{ data_mount_point }}:/app/data
                    ports:
                      - "{{ docker_port }}:3001"
                    restart: unless-stopped
                    environment:
                      - TZ=Europe/London
                    networks:
                      - uptime-kuma

                networks:
                  uptime-kuma:
                    driver: bridge

          - name: Start Uptime Kuma with Docker Compose
            community.docker.docker_compose_v2:
              project_src: "{{ docker_compose_dir }}"
              state: present

          - name: Wait for Uptime Kuma to start
            uri:
              url: "http://localhost:{{ docker_port }}"
              method: GET
              status_code: 200
            register: uptime_kuma_health
            retries: 30
            delay: 5
            until: uptime_kuma_health.status == 200

          - name: Run Certbot to get HTTPS certificate
            include_role:
              name: certbot
            when: enable_https | default(true) | bool

          - name: Deploy SSL Nginx configuration after certificates are obtained
            include_role:
              name: nginx
            vars:
              skip_install: true
            when: enable_https | default(true) | bool

runcmd:
  # Add Ansible PPA and install latest version
  - apt-add-repository --yes --update ppa:ansible/ansible
  - apt install -y ansible

  # Clone WebKit repo to get Ansible roles
  - git clone https://github.com/ainsleydev/webkit.git /opt/webkit

  # Configure Ansible roles path
  - export ANSIBLE_ROLES_PATH=/opt/webkit/platform/ansible/roles

  # Run Ansible playbook with WebKit roles
  - ANSIBLE_ROLES_PATH=/opt/webkit/platform/ansible/roles ansible-playbook -i /tmp/ansible-inventory.ini /tmp/uptime-kuma-playbook.yaml --connection=local

final_message: 'Uptime Kuma server is ready after $UPTIME seconds'
